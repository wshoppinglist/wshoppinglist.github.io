<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shared Shopping List</title>
  <style>
    :root {
      --bg: #f3f4f6;
      --card: #ffffff;
      --accent: #2563eb;
      --muted: #6b7280;
      --success: #10b981;
    }
    *{box-sizing:border-box}
    body{
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin:0;
      background:linear-gradient(180deg,#f8fafc, var(--bg));
      color:#111827;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:32px;
    }
    .container{
      width:100%;
      max-width:900px;
      background:var(--card);
      border-radius:12px;
      box-shadow:0 6px 30px rgba(2,6,23,0.08);
      padding:20px;
    }
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{margin:0;font-size:20px}
    p.lead{margin:0;color:var(--muted);font-size:13px}
    .controls{display:flex;gap:8px;align-items:center}
    input[type="text"], input[type="email"], input[type="password"]{
      padding:10px 12px;border-radius:8px;border:1px solid #e6edf3;min-width:200px;
    }
    button{
      padding:10px 12px;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer;
    }
    button.ghost{background:transparent;border:1px solid #e6edf3;color:var(--muted)}
    main{margin-top:18px;display:grid;grid-template-columns:1fr 320px;gap:18px}
    .panel{background:#fbfdff;border-radius:10px;padding:14px;min-height:120px}
    .add-area{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .list{list-style:none;padding:0;margin:0;max-height:520px;overflow:auto}
    .item{
      display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;border:1px solid #eef2f7;margin-bottom:8px;
    }
    .left{display:flex;gap:12px;align-items:center}
    .name{font-weight:600}
    .meta{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:8px}
    .small{font-size:13px;padding:6px 8px;border-radius:8px;border:0}
    .checkbox{
      width:18px;height:18px;border-radius:4px;border:2px solid #e6edf3;display:inline-block;cursor:pointer;
      display:flex;align-items:center;justify-content:center;
    }
    .checked{background:var(--success);color:white;border-color:var(--success)}
    .signed-in{display:flex;flex-direction:column;gap:8px}
    .room{display:flex;gap:8px;align-items:center}
    .hint{font-size:12px;color:var(--muted)}
    footer{margin-top:12px;font-size:12px;color:var(--muted)}
    @media (max-width:900px){
      main{grid-template-columns:1fr}
      .container{padding:12px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Shared Shopping List</h1>
        <p class="lead">A small real-time list for your group — updates instantly for everyone.</p>
      </div>
      <div class="controls" id="authArea">
        <!-- Auth controls injected here -->
        <button id="signInBtn">Sign in</button>
      </div>
    </header>

    <main>
      <section class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong id="roomLabel">Room: <span id="roomIdDisplay">(not set)</span></strong>
            <div class="hint">Share the "room id" with your 3 teammates.</div>
          </div>
          <div>
            <input id="roomInput" type="text" placeholder="room-id (e.g. grocery123)" />
            <button id="joinRoom" class="ghost">Join</button>
          </div>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid #eef2f7" />

        <div class="add-area">
          <input id="itemInput" type="text" placeholder="Add item (e.g. Milk)" />
          <button id="addBtn">Add</button>
          <select id="qtySelect" style="padding:8px;border-radius:8px;border:1px solid #e6edf3">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="bulk">Bulk</option>
          </select>
        </div>

        <ul id="itemsList" class="list" aria-live="polite"></ul>
      </section>

      <aside class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Group Info</strong>
          <div id="memberCount">—</div>
        </div>

        <div style="margin-top:12px" id="userInfo">
          <!-- user info here -->
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid #eef2f7" />

        <div>
          <strong>How it works</strong>
          <ol style="padding-left:18px">
            <li>Each user signs in (recommended) or continues anonymously</li>
            <li>Pick or create a small room-id and share it</li>
            <li>Everyone using that room sees the same list in real time</li>
          </ol>
        </div>

        <footer>
          Tips: use a short room id (no spaces). To keep this private, only share the room id with the 3 people.
        </footer>
      </aside>
    </main>
  </div>

  <!-- Firebase v10 modular via CDN -->
  <script type="module">
    // 1) Replace this config with your Firebase project's config.
    const firebaseConfig = {
    apiKey: "AIzaSyAeZkmjQzk1rycB7JbFN17fedJM8wwKiHA",
    authDomain: "wshoppinglist-5e569.firebaseapp.com",
    projectId: "wshoppinglist-5e569",
    storageBucket: "wshoppinglist-5e569.firebasestorage.app",
    messagingSenderId: "1076581709165",
    appId: "1:1076581709165:web:19c432e3ee7b95d4f61664",
    measurementId: "G-K4K9WB9HHT"
  };

    // 2) Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, onSnapshot, updateDoc, deleteDoc,
      serverTimestamp, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut, signInAnonymously
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

    // init
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // DOM
    const signInBtn = document.getElementById('signInBtn');
    const authArea = document.getElementById('authArea');
    const roomInput = document.getElementById('roomInput');
    const joinRoomBtn = document.getElementById('joinRoom');
    const roomLabel = document.getElementById('roomIdDisplay');
    const itemInput = document.getElementById('itemInput');
    const addBtn = document.getElementById('addBtn');
    const itemsList = document.getElementById('itemsList');
    const userInfo = document.getElementById('userInfo');
    const memberCount = document.getElementById('memberCount');

    let currentRoom = null;
    let unsubscribeSnapshot = null;
    let currentUser = null;

    // Auth functionality
    function createAuthUI(user) {
      authArea.innerHTML = '';
      const wrap = document.createElement('div');
      wrap.className = 'signed-in';
      if (user) {
        const name = user.displayName || user.email || 'Anonymous';
        const id = document.createElement('div');
        id.innerHTML = `<strong>${name}</strong><div class="hint">uid: ${user.uid.slice(0,8)}...</div>`;
        const out = document.createElement('button');
        out.textContent = 'Sign out';
        out.onclick = () => signOut(auth);
        wrap.appendChild(id);
        wrap.appendChild(out);
      } else {
        const signGoogle = document.createElement('button');
        signGoogle.textContent = 'Sign in with Google';
        signGoogle.onclick = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(e => alert(e.message));
        const signAnon = document.createElement('button');
        signAnon.textContent = 'Continue anonymously';
        signAnon.className = 'ghost';
        signAnon.onclick = () => signInAnonymously(auth).catch(e => alert(e.message));
        wrap.appendChild(signGoogle);
        wrap.appendChild(signAnon);
      }
      authArea.appendChild(wrap);
    }

    onAuthStateChanged(auth, user => {
      currentUser = user;
      createAuthUI(user);
      renderUserInfo();
    });

    // Join a room
    joinRoomBtn.addEventListener('click', () => {
      const r = roomInput.value.trim();
      if (!r) { alert('Please enter a room id.'); return; }
      joinRoom(r);
    });

    async function joinRoom(roomId) {
      if (unsubscribeSnapshot) unsubscribeSnapshot();
      currentRoom = roomId;
      roomLabel.textContent = roomId;
      itemsList.innerHTML = '<li class="hint">Loading…</li>';

      // Query list ordered by createdAt
      const roomCol = collection(db, `rooms/${roomId}/items`);
      const q = query(roomCol, orderBy('createdAt'));
      unsubscribeSnapshot = onSnapshot(q, snapshot => {
        itemsList.innerHTML = '';
        let count = 0;
        snapshot.forEach(docSnap => {
          const d = { id: docSnap.id, ...docSnap.data() };
          renderItem(d);
          count++;
        });
        memberCount.textContent = `${count} items`;
      }, err => {
        console.error(err);
        alert('Error loading room: ' + err.message);
      });
    }

    // Add item
    addBtn.addEventListener('click', async () => {
      const name = itemInput.value.trim();
      if (!name || !currentRoom) { alert('Enter an item and join a room first.'); return; }
      const qty = document.getElementById('qtySelect').value;
      const item = {
        name,
        qty,
        addedBy: currentUser ? (currentUser.displayName || currentUser.email || currentUser.uid.slice(0,8)) : 'anon',
        done: false,
        createdAt: serverTimestamp()
      };
      try {
        await addDoc(collection(db, `rooms/${currentRoom}/items`), item);
        itemInput.value = '';
      } catch (e) {
        alert('Add failed: ' + e.message);
      }
    });

    // render item
    function renderItem(item) {
      const li = document.createElement('li');
      li.className = 'item';
      const left = document.createElement('div'); left.className='left';
      const check = document.createElement('div');
      check.className = 'checkbox' + (item.done ? ' checked' : '');
      check.innerHTML = item.done ? '✓' : '';
      check.title = item.done ? 'Mark as not bought' : 'Mark as bought';
      check.onclick = async () => {
        try {
          await updateDoc(doc(db, `rooms/${currentRoom}/items`, item.id), { done: !item.done });
        } catch (e) { alert('Update failed: ' + e.message) }
      };
      const name = document.createElement('div');
      name.innerHTML = `<div class="name">${escapeHtml(item.name)}</div><div class="meta">${escapeHtml(item.qty)} • added by ${escapeHtml(item.addedBy)}</div>`;
      left.appendChild(check);
      left.appendChild(name);

      const actions = document.createElement('div'); actions.className='actions';
      const del = document.createElement('button'); del.className='small';
      del.textContent = 'Remove';
      del.onclick = async () => {
        if (!confirm('Remove item?')) return;
        try { await deleteDoc(doc(db, `rooms/${currentRoom}/items`, item.id)); } catch (e) { alert('Delete failed: ' + e.message) }
      };
      actions.appendChild(del);

      li.appendChild(left);
      li.appendChild(actions);
      itemsList.appendChild(li);
    }

    function renderUserInfo() {
      userInfo.innerHTML = '';
      if (currentUser) {
        const name = currentUser.displayName || currentUser.email || 'Anonymous';
        userInfo.innerHTML = `<div><strong>${escapeHtml(name)}</strong></div><div class="hint">UID: ${escapeHtml(currentUser.uid.slice(0,8))}…</div>`;
      } else {
        userInfo.innerHTML = `<div class="hint">Not signed in. Signing in helps track who added items.</div>`;
      }
    }

    // small helper
    function escapeHtml(s='') {
      return String(s).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // sign-in button fallback for old browsers
    signInBtn.addEventListener('click', () => {
      // simply show auth UI
      createAuthUI(currentUser);
    });

    // Optional: join room from URL param ?room=xxx
    const params = new URLSearchParams(location.search);
    const initialRoom = params.get('room');
    if (initialRoom) {
      roomInput.value = initialRoom;
      joinRoom(initialRoom);
    }

  </script>
</body>
</html>
